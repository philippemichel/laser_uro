---
title: "Laser en urologie"
subtitle: "Évenements indésirables"
author: "Philippe MICHEL"
date: "`r format(Sys.Date(),'%d %B %Y')`"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
    toc: yes
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    theme: lumen
    anchor_sections: true
    citation_package: biblatex
  pdf_document:
    keep_tex: yes
    latex_engine: lualatex
    toc: yes  
    citation_package: biblatex
editor_options:
  chunk_output_type: console
bibliography: "stat.bib"
biblio-style: "plain"
link-citations: true
---

```{r setup, include= FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE,
# knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
#
 fig.width = 7,
 fig.asp = 0.8,
 out.width = "100%"
)
```

```{r info}
library(prettydoc)
library(forcats)
library(stringr)
library(treemap)
library(missMDA)
library(FactoMineR)
library(epiDisplay)
library(factoextra)
library(baseph)
library(knitr)
library(finalfit)
library(Hmisc)
library(tidyr)
library(ggplot2)
library(kableExtra)
library(forestmodel)
library(lubridate)
library(dplyr)
library(table1)
library(janitor)
library(parameters)
library(see)
# sessionInfo()
```

```{r themeg}
theme_phm <- function(base_size = 14) {
  theme_light(base_size = base_size) %+replace%
    theme(
      plot.title = element_text(
        size = rel(1.2),
        face = "bold",
        margin = margin(10, 0, 5, 0),
        hjust = 0
      ),
      axis.title.x = element_text(size = 12),
      axis.title.y = element_text(size = 12),
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      legend.position = "none"
    )
}
```


```{r import}
rm(list=ls())
tt <- read.csv("data/laser.csv", header = TRUE, as.is = FALSE)
tt <- clean_names(tt)
liste <- read.csv("data/liste.csv")
tt$laser <-
  as.factor(ifelse(tt$id %in% liste$liste, "laser", "autre"))
tt <- as_tibble(tt)
tt$bmi <- 10000 * tt$poids/tt$taille^2
tt$bmi <- cut(tt$bmi,
  include.lowest = FALSE,
  right = FALSE,
  dig.lab = 4,
  breaks = c(0, 18.5, 25, 30,100),
  labels = c("Underweight","Normal weight","Overweight","Obese")
)
tt$asa <- as.factor(tt$asa)
names(tt) <- str_replace_all(names(tt), "_", ".")
ttlaser <- dplyr::filter(tt, libelle.cim10 %in% c("Affection de la prostate","Autres calculs des voies urinaires inférieures", "Calcul urinaire","Colique néphrétique", "Congestion et hémorragie prostatiques", "Dysplasie de la prostate","Dysurie", "Hyperplasie de la prostate","Incontinence urinaire"," Tumeur bénigne de la prostate"))
tt$evenement <-
  fct_lump(tt$evenement, n = 10, other_level = "autre")
tt$libelle.cim10 <-
  fct_lump(tt$libelle.cim10, n = 10, other_level = "autre")
tt$libelle.ccam <-
  fct_lump(tt$libelle.ccam, n = 10, other_level = "autre")
ttlaser$evenement <-
  fct_lump(ttlaser$evenement, n = 10, other_level = "autre")
ttlaser$libelle.cim10 <-
  fct_lump(ttlaser$libelle.cim10, n = 10, other_level = "autre")
ttlaser$libelle.ccam <-
  fct_lump(ttlaser$libelle.ccam, n = 10, other_level = "autre")
```

# Description des données

La base de données comprend `r dim(tt)[1]` cas pour `r dim(tt)[2]` variables. Le nombre de cas peu paraître important mais il n'y a que 149 cas de laser. le nombre de variables devient donc important & il est hors de question de faire des tests au hasard sur toutes les variables. 

Les données des variables "Évenement", "CIM10" & "CCAM" ont été nettoyées & regroupées. Seuless les dix intitulés les plus fréquents seront pris en compte.



```{r pyr}
epiDisplay::pyramid(age = tt$age,sex = tt$sexe, binwidth = 10, col.gender = c("pink","skyblue1"), main = "Pyramide des âges", printTable = FALSE)
```

## Avant & pendant l'évenement

### Diagnostic

```{r eve}
zz <- table(tt$evenement)
zz <- zz[-12]
zz <- sort(zz, decreasing = TRUE)
kable(zz,
      col.names = c("", "n"),
      caption = "Libellés CCAM les plus fréquents" ,
      label = "pyr")

tt %>%
  drop_na(cause.immediate.principale) %>%
  ggplot() +
  aes(x = fct_infreq(cause.immediate.principale), fill = laser) +
  geom_bar(stat = "count") +
  labs(title = "Problème rencontré",
       subtitle = "Toutes interventions",
       y = "n") +
  theme_light() +
  scale_fill_material() +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(
      size = 12 ,
      angle = 60,
      hjust = 1
    ),
    axis.text.y = element_text(size = 12),
    legend.position = "top"
  ) 

ttlaser %>%
  drop_na(cause.immediate.principale) %>%
  ggplot() +
  aes(x = fct_infreq(cause.immediate.principale), fill = laser) +
  geom_bar(stat = "count") +
  labs(title = "Problème rencontré",
       subtitle = "intervention avec possible laser",
       y = "n") +
  theme_light() +
  scale_fill_material() +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(
      size = 12 ,
      angle = 60,
      hjust = 1
    ),
    axis.text.y = element_text(size = 12),
    legend.position = "top"
  ) 
  
```

### CIM 10

```{r cim}
zz <- table(tt$libelle.cim10)
zz <- zz[-11]
zz <- sort(zz, decreasing = TRUE)
kable(zz, col.names = c("", "n"), caption = "Libellés CIM10 les plus fréquents" , label = "pyr")
#
tt %>%
  drop_na(libelle.cim10) %>%
  ggplot() +
  aes(x = fct_infreq(libelle.cim10), fill = laser) +
  geom_bar(stat = "count") +
  labs(title = "Diagnostic (CIM 10)",
       y = "n") +
  theme_light() +
  scale_fill_material() +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(
      size = 12 ,
      angle = 60,
      hjust = 1
    ),
    axis.text.y = element_text(size = 12),
    legend.position = "bottom"
  )
#
dd <- slice(tt, c(2:13,16))

```

### CCAM
```{r ccam}
zz <- table(tt$libelle.ccam)
zz <- zz[-12]
zz <- sort(zz, decreasing = TRUE)
kable(zz, col.names = c("", "n"), caption = "Libellés CCAM les plus fréquents" , label = "pyr")
#
```

### Autres données

```{r tab1av}
table1(~cause.immediate.principale + situation.a.risque + sexe + age + bmi + grossesse + avant.complexite.clinique + asa + but.acte.medical + produit + periode.vulnerable + degre.urgence.pac + pac.programmee | laser, data = tt, overall = "Total")
```

### Analyse factorielle

Une classification non supervisée des cas a été réalisée. On ne prend en compte que les catégories CIM 10 où le Laser est utilisé.

les résultats sont à prendre avec précaution, les axes présentés ne montrent que 6 % de la variance totale. Vu la faible efficacité nous n'irons pas plus loin sur cet axe.

```{r estim1, cache = TRUE, eval = TRUE}
dd <- select(ttlaser, c(3,4,6,9,10,11,13,16,17,19,20,21,23,25,26,46,47))
dd$age <- cut(dd$age,seq(0,100,20))
#nn <- estim_ncpFAMD(dd)
nn <- 0
ddi <- imputeMCA(dd) 
ddi <- ddi$completeObs
```

```{r fact1, eval = TRUE}
mtt <- MCA(ddi, graph = FALSE)
```

```{r factg1, eval = TRUE}
fviz_mca_ind(mtt, geom = "point", 
             habillage = ddi$laser,
             addEllipses = TRUE,
             palette = "lancet",
             title = "Analyse factorielle - Intervention avec Laser"
)
```

Les interventions avec laser représentent un groupe homogène de cas.

## Pendant l'évènement

```{r tab1pd}
table1(~ infection.nosocomiale + niveau.gravite + identification.causes.immediates + causes.liees.patient + causes.liees.taches + causes.liees.soignant + cause.individu + causes.liees.equipe + causes.liees.environnement.travail + causes.liees.organisation + causes.liees.institutionnel + identifie.barrieres.pas.fonctionnees + identifile.barrieres.efficasses + qualifieriez.vous + existe.recommandation + au.sein.equipe| laser, data = tt, overall ="Total")
```



## Après l'évènemement

```{r tab1ap}
table1(~ rmm + sein.etablissement +al.ars + autres.institutions + patient.informe  | laser, data = tt, overall ="Total")   
```       
        
       
# Matériel & Laser
```{r mat0}
clas <- chisq.test(ttlaser$cause.immediate.principale,ttlaser$laser)
pp <- beaup(clas$p.value)

zz <- table(tt$cause.immediate.principale <- fct_rev(fct_relevel(tt$cause.immediate.principale, "MATERIEL ET STERILISATION" )),tt$laser)
zz <- proportions(zz,2)*100
aa <- as.data.frame(zz)
names(aa) <- c("cause","laser","fq")
aa %>% 
ggplot() +
  aes(x= laser, y = fq, fill = cause) +
  geom_bar(stat= "identity") +
  labs(title = "Cause retenue & emploi du Laser",
       y = "%") +
  theme_light() +
  scale_fill_material() +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 12),
    axis.title.x = element_blank(),
    legend.title = element_blank(),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(
      size = 12 ,
      angle = 60,
      hjust = 1
    ),
    axis.text.y = element_text(size = 12),
    legend.position = "right"
  )
```
Les problèmes rencontrées pendant les interventions avec Laser semblent différentes des autres interventions (p = `r pp`).

Les problèmes liés au matériel semblent fréquents lors des interventions avec Laser. On se concentre sur les types d’interventions où le Laser est parfois utilisé.

```{r mat1}
ttlaser$materiel <- as.factor(ifelse(ttlaser$cause.immediate.principale == "MATERIEL ET STERILISATION","matériel", "autre cause" ))
cc(ttlaser$materiel,ttlaser$laser)
aa <- forest_model_format_options(text_size = 4, colour = "black")
ll <- glm(materiel~laser + age + bmi + asa + avant.complexite.clinique + pac.programmee, data = ttlaser, family = "binomial") 
forest_model(ll, factor_separate_line = TRUE, recalculate_width = TRUE,  format_options = aa)
```
L'utilisation du Laser est donc un facteur de risque d'avoir un problème avec le matériel. En standardisant des facteurs de risques simples (âge, complexité clinique, ASA, BMI, situation d'urgence) l'usage du Laser reste un facteur de risque majeur d'avoir un problème avec le matériel. À noter qu'il y a moins d’évènements liés au matériel en urgence que sur des interventions programmées ? 

# Technique 

**Petit paragraphe à ajouter en fin de “matériel & méthode”**

*Pas fini !!!*

Les données discrètes ont été décrites par leur fréquence exprimée en pourcentage avec son intervalle de confiance à 95 % et ont été comparées par le test exact de Fisher vu la faible effectif. Les intervalles de confiance n’ont été réalisés qu’après transformation angulaire. Les données numériques ont été décrites par leur moyenne (avec son intervalle de confiance à 95 % calculé par bootstrap) et l’écart-type. Les données continues ont été comparées par le test de Student après vérification de l’égalité des variances. L’analyse factorielle a été réalisée en analyse des correspondances multiples après imputation des données manquantes, possible ici en raison du faible nombre de celles-ci.
Les statistiques ont été réalisées grâce au logiciel R[@rstat] avec en particulier les packages du Tidyverse[@tidy] & factoMineR[@facto].

# References

